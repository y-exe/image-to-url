<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像あぷろだ - 無料・高機能な画像アップローダー</title>
    
    <meta name="description" content="無料の画像アップローダー。画像をアップロードして恒久的なURLを簡単に生成・共有できます。">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Zen Maru Gothic',sans-serif;background-color:#f6f6f6;color:#333;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:20px;box-sizing:border-box}
        .container{background-color:white;padding:40px 50px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.05);text-align:center;width:100%;max-width:500px}h1{margin-top:0;margin-bottom:15px;font-weight:700;font-size:2em}.description{font-size:.9em;color:#666;line-height:1.6;margin-bottom:30px}#file-input{display:none}#upload-area{display:block;border:2px solid #000;background-color:#fff;color:#000;border-radius:999px;padding:18px 20px;cursor:pointer;transition:all .2s ease;font-size:1.1em;font-weight:500}#upload-area:hover{background-color:#000;color:#fff}#status{font-weight:500;transition:margin-top .4s ease;margin-top:20px;min-height:1.2em}#status:empty{margin-top:0;min-height:0}footer{margin-top:40px;color:#aaa;font-size:.8em}@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.fade-in-up{opacity:0;animation:fadeInUp .6s ease-out forwards;animation-delay:calc(var(--order) * .1s)}
        .history-section { margin-top: 30px; }
        #history-container { display: flex; flex-direction: column-reverse; gap: 15px; }
        .history-item { background: #f9f9f9; border-radius: 12px; padding: 15px; text-align: left; animation: fadeInUp .5s ease-out; }
        .history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .file-name { font-weight: 500; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 10px; }
        .view-image-btn { display: inline-block; text-decoration: none; border: 2px solid #000; background: #fff; color: #000; border-radius: 999px; padding: 4px 12px; font-size: 0.8em; font-weight: 500; transition: all .2s ease; flex-shrink: 0; }
        .view-image-btn:hover { background: #000; color: #fff; }
        #clear-history-btn { font-family: inherit; font-size: 0.9em; background: none; border: 2px solid #000; color: #000; border-radius: 999px; padding: 8px 20px; cursor: pointer; transition: all .2s ease; margin-top: 20px; display: none; }
        #clear-history-btn:hover { background: #000; color: #fff; }
        .url-box{background-color:#f0f0f0;padding:10px 15px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}.url-box input{flex-grow:1;border:none;background:none;font-size:1em;padding-right:10px}.copy-btn{padding:8px 15px;border:none;background-color:#333;color:white;border-radius:8px;cursor:pointer;transition:background-color .2s ease;flex-shrink:0}.copy-btn:hover{background-color:#555}
        .separator{display:flex;align-items:center;text-align:center;margin:30px 0;color:#ccc}.separator hr{flex-grow:1;border:none;border-top:1px solid #eee;margin:0}.separator span{padding:0 15px;font-size:.9em;font-weight:500;letter-spacing:.1em}.api-docs summary{display:block;list-style:none;border:2px solid #000;background-color:#000;color:#fff;border-radius:999px;padding:14px 20px;cursor:pointer;transition:opacity .2s ease;font-size:1em;font-weight:500}.api-docs summary:hover{opacity:.8}.api-docs summary::-webkit-details-marker{display:none}.api-docs>div{margin-top:20px;text-align:left}.api-docs pre{background-color:#2d2d2d;color:#ccc;padding:15px;border-radius:8px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New',Courier,monospace}
        .mobile-only{display:inline}.desktop-only{display:none}
        #upload-area.disabled { background-color: #e9e9e9; border-color: #ccc; color: #999; cursor: not-allowed; pointer-events: none; }
        #upload-area.disabled:hover { background-color: #e9e9e9; color: #999; }
        @media (min-width: 500px){ .mobile-only{display:none} .desktop-only{display:inline} }
        @media (max-width: 500px) {
            body { background-color: #fff; padding: 0; }
            .container { box-shadow: none; border-radius: 0; padding: 30px 15px; min-height: 100vh; }
            .url-box { flex-direction: column; padding: 15px; }
            .url-box input { width: 100%; padding-right: 0; margin-bottom: 10px; text-align: center; font-size: 0.9em; }
            .copy-btn { width: 100%; padding: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="fade-in-up" style="--order: 0;">画像あぷろだ</h1>
        <p class="description fade-in-up" style="--order: 1;">
            画像を直画像のURLにすることができます。<br>児童ポルノ、グロ画像は禁止です。
        </p>
        <label for="file-input" id="upload-area" class="fade-in-up" style="--order: 2;">
            <span class="mobile-only" id="upload-text-mobile">アップロード</span>
            <span class="desktop-only" id="upload-text-desktop">クリック または ドラッグ＆ドロップ</span>
        </label>
        <input type="file" id="file-input" accept="image/*">
        <div id="status"></div>
        
        <div class="history-section fade-in-up" style="--order: 3;">
            <div id="history-container"></div>
            <button id="clear-history-btn">履歴をクリア</button>
        </div>
        
        <div class="separator fade-in-up" style="--order: 4;"><hr><span>API</span><hr></div>
        <details class="api-docs fade-in-up" style="--order: 5;">
            <summary>APIドキュメント</summary>
            <div>
                <p>このサービスは公開APIを提供しています。以下のエンドポイントに multipart/form-data 形式で画像をPOSTすることで利用できます。</p>
                <h4>エンドポイント</h4><pre><code id="api-endpoint-display"></code></pre>
                <h4>リクエスト (cURLの例)</h4><pre><code id="api-curl-display"></code></pre>
            </div>
        </details>
        
        <footer class="fade-in-up" style="--order: 6;"></footer>
    </div>

    <script>
        const uploadArea = document.getElementById("upload-area");
        const fileInput = document.getElementById("file-input");
        const statusDiv = document.getElementById("status");
        const historyContainer = document.getElementById("history-container");
        const clearHistoryBtn = document.getElementById("clear-history-btn");
        const uploadTextMobile = document.getElementById("upload-text-mobile");
        const uploadTextDesktop = document.getElementById("upload-text-desktop");

        const API_BASE_URL = "https://i.yexe.xyz";
        
        const API_ENDPOINT = `${API_BASE_URL}/upload`;
        const HISTORY_KEY = "imageUploadHistory";
        const MAX_FILE_SIZE = 8 * 1024 * 1024;

        document.getElementById('api-endpoint-display').textContent = `POST ${API_ENDPOINT}`;
        document.getElementById('api-curl-display').textContent = `curl -X POST ${API_ENDPOINT} \\\n-F "image=@/path/to/image.jpg"`;

        const formatBytes = (bytes, decimals = 2) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        const renderHistory = () => {
            historyContainer.innerHTML = '';
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            if (history.length === 0) {
                historyContainer.innerHTML = '<p style="color:#aaa; font-size:0.9em; margin-top:20px;">まだアップロード履歴はありません。</p>';
                clearHistoryBtn.style.display = 'none';
                return;
            }
            clearHistoryBtn.style.display = 'block';
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                const uniqueId = `url-${Date.now()}-${Math.random()}`;
                historyItem.innerHTML = `<div class="history-item-header"><span class="file-name" title="${item.fileName}">${item.fileName}</span><a href="${item.url}" target="_blank" rel="noopener noreferrer" class="view-image-btn">画像を確認</a></div><div class="url-box"><input type="text" id="${uniqueId}" value="${item.url}" readonly><button class="copy-btn" onclick="copyUrl('${uniqueId}')">コピー</button></div>`;
                historyContainer.appendChild(historyItem);
            });
        };

        const uploadFileWithProgress = (file) => {
            const formData = new FormData();
            formData.append("image", file);
            const xhr = new XMLHttpRequest();
            xhr.upload.addEventListener("progress", (event) => {
                if (event.lengthComputable) {
                    statusDiv.textContent = `アップロード中... (${formatBytes(event.loaded)} / ${formatBytes(event.total)})`;
                }
            });
            xhr.addEventListener("load", () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (!data.success) throw new Error(data.error || "不明なエラーが発生しました");
                        const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                        history.push({ url: data.url, fileName: data.fileName });
                        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                        statusDiv.textContent = "アップロード完了！";
                        renderHistory();
                    } catch (error) { statusDiv.textContent = `エラー: レスポンスの解析に失敗しました。`; }
                } else {
                    try {
                         const errorData = JSON.parse(xhr.responseText);
                         statusDiv.textContent = `エラー: ${errorData.error || xhr.statusText}`;
                    } catch { statusDiv.textContent = `エラー: ${xhr.status} ${xhr.statusText}`; }
                }
            });
            xhr.addEventListener("error", () => { statusDiv.textContent = "エラー: ネットワークエラーが発生しました。"; });
            xhr.open("POST", API_ENDPOINT, true);
            xhr.send(formData);
        }

        const handleFiles = (files) => {
            if (files.length === 0) return;
            const file = files[0];
            if (file.size > MAX_FILE_SIZE) {
                statusDiv.textContent = `エラー: ファイルサイズが${formatBytes(MAX_FILE_SIZE)}を超えています。`;
                return;
            }
            statusDiv.textContent = "アップロード準備中...";
            uploadFileWithProgress(file);
        };

        const copyUrl = (elementId) => {
            const input = document.getElementById(elementId);
            if (navigator.clipboard) {
                navigator.clipboard.writeText(input.value).then(() => { statusDiv.textContent = "コピーしました！"; }, () => { statusDiv.textContent = "コピーに失敗しました"; });
            } else {
                input.select();
                document.execCommand("copy");
                statusDiv.textContent = "コピーしました！";
            }
        };

        const setupUploadListeners = () => {
            ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
                uploadArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            uploadArea.addEventListener("drop", e => handleFiles(e.dataTransfer.files), false);
            fileInput.addEventListener("change", e => handleFiles(e.target.files));
        };
        
        const disableUpload = () => {
            uploadTextMobile.textContent = "エラー発生中";
            uploadTextDesktop.textContent = "現在一時的に機能してません。";
            uploadArea.classList.add("disabled");
            fileInput.disabled = true;
        };

        const checkApiStatus = async () => {
            try {
                const healthCheckUrl = `${API_BASE_URL}/health`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const response = await fetch(healthCheckUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`API server is not responding correctly. Status: ${response.status}`);
                }
                setupUploadListeners();
            } catch (error) {
                console.error("API status check failed:", error);
                disableUpload();
            }
        };

        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('本当にすべての履歴を削除しますか？')) {
                localStorage.removeItem(HISTORY_KEY);
                statusDiv.textContent = "履歴をクリアしました。";
                renderHistory();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            renderHistory();
            checkApiStatus();
        });
    </script>
</body>
</html>
